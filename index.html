<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calcolo canale aria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Calcolo Aria">

  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-top: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    h2 {
      font-size: 1rem;
      margin: 0 0 8px 0;
    }

    label {
      font-size: 0.8rem;
      color: #cbd5e1;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #e2e8f0;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      margin-top: 6px;
      cursor: pointer;
    }

    .btn-primary {
      background: #22c55e;
      color: white;
      margin-bottom: 8px;
    }

    .results div {
      margin-bottom: 6px;
      font-size: 0.9rem;
      border-bottom: 1px dashed #334155;
      padding-bottom: 3px;
    }

    .note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 6px;
    }

    .tag-ok {
      background: #16a34a;
      color: #f9fafb;
    }

    .tag-high {
      background: #b45309;
      color: #fef3c7;
    }

    .tag-low {
      background: #0369a1;
      color: #e0f2fe;
    }

    .tag-na {
      background: #4b5563;
      color: #e5e7eb;
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <h1>Calcolo Canale Aria</h1>

  <!-- INPUT -->
  <div class="card">
    <h2>Input</h2>

    <label>Portata Q (m³/h)</label>
    <input id="flow" type="number" placeholder="es. 1200">

    <label>Velocità V (m/s) (opzionale)</label>
    <input id="velocity" type="number" placeholder="es. 4 (lascia vuoto se non la sai)">

    <label>Scenario impianto (limiti velocità)</label>
    <select id="scenario">
      <option value="res">Abitazione – mandata</option>
      <option value="office">Uffici – mandata</option>
      <option value="hospital">Ospedale – mandata</option>
      <option value="extract">Estrazione / cucine</option>
      <option value="main">Montante principale</option>
      <option value="none">Nessun limite (libero)</option>
    </select>
    <div class="note" id="scenarioInfo"></div>

    <label>Tipo sezione</label>
    <select id="geom">
      <option value="rect">Rettangolare</option>
      <option value="circ">Circolare</option>
    </select>

    <div id="rect_fields">
      <div class="row-2">
        <div>
          <label>Base (mm)</label>
          <input id="base" type="number" placeholder="es. 400">
        </div>
        <div>
          <label>Altezza (mm)</label>
          <input id="height" type="number" placeholder="es. 200">
        </div>
      </div>
    </div>

    <div id="circ_fields" style="display:none;">
      <label>Diametro (mm)</label>
      <input id="diam" type="number" placeholder="es. 250">
    </div>

    <button class="btn-primary" onclick="calcola()">Calcola</button>
  </div>

  <!-- RISULTATI -->
  <div class="card">
    <h2>Risultati</h2>
    <div class="results">
      <div>Area A:
        <span id="areaOut">—</span>
      </div>
      <div>Velocità considerata V:
        <span id="vEffOut">—</span>
        <span id="vEffTag" class="tag tag-na">n/d</span>
      </div>
      <div>Diametro equivalente Deq (da A): <span id="deqOut">—</span></div>
      <div>DN standard più vicino: <span id="stdDNOut">—</span></div>
      <div>Velocità con DN standard: <span id="stdDNVOut">—</span></div>

      <div id="circOut" style="display:none;">
        <div>Velocità con diametro inserito:
          <span id="vRealOut">—</span>
          <span id="vRealTag" class="tag tag-na">n/d</span>
        </div>
        <div>Sezione quadrata equivalente (lato): <span id="squareSideOut">—</span></div>
      </div>
    </div>
  </div>

  <!-- CONVERSIONI -->
  <div class="card">
    <h2>Conversioni</h2>
    <div class="results">
      <div>Q in m³/s: <span id="qM3sOut">—</span></div>
      <div>A in cm²: <span id="areaCm2Out">—</span></div>
      <div>V in km/h: <span id="vKmhOut">—</span></div>
    </div>
  </div>

<script>
function round(v, d) {
  return Math.round(v * Math.pow(10, d)) / Math.pow(10, d);
}

const scenarios = {
  res:      { name: "Abitazione – mandata",      vMin: 1.5, vMax: 3.5 },
  office:   { name: "Uffici – mandata",          vMin: 2.0, vMax: 4.0 },
  hospital: { name: "Ospedale – mandata",        vMin: 1.5, vMax: 3.0 },
  extract:  { name: "Estrazione / cucine",       vMin: 5.0, vMax: 8.0 },
  main:     { name: "Montante principale",       vMin: 6.0, vMax: 9.0 },
  none:     { name: "Nessun limite",             vMin: null, vMax: null }
};

// diametri standard usati
const stdDiameters = [100, 125, 150, 160, 200, 250, 315, 355, 400, 450, 500, 560, 600];

document.addEventListener("DOMContentLoaded", function() {
  const geomSel = document.getElementById("geom");
  const rectFields = document.getElementById("rect_fields");
  const circFields = document.getElementById("circ_fields");
  const scenSel = document.getElementById("scenario");
  const scenInfo = document.getElementById("scenarioInfo");

  function updateScenarioInfo() {
    const s = scenarios[scenSel.value];
    if (s.vMin != null && s.vMax != null) {
      scenInfo.textContent = s.name + " – range consigliato: " + s.vMin + " – " + s.vMax + " m/s";
    } else {
      scenInfo.textContent = s.name + " – nessun limite preimpostato";
    }
  }
  scenSel.addEventListener("change", updateScenarioInfo);
  updateScenarioInfo();

  geomSel.addEventListener("change", function() {
    if (geomSel.value === "rect") {
      rectFields.style.display = "";
      circFields.style.display = "none";
    } else {
      rectFields.style.display = "none";
      circFields.style.display = "";
    }
    document.getElementById("circOut").style.display = "none";
  });
});

function getVelocityTag(v, vMin, vMax) {
  if (!v || v <= 0 || vMin == null || vMax == null) {
    return { text: "n/d", cls: "tag-na" };
  }
  if (v < vMin) return { text: "Bassa", cls: "tag-low" };
  if (v <= vMax) return { text: "OK", cls: "tag-ok" };
  return { text: "Alta", cls: "tag-high" };
}

function calcola() {
  const Q = parseFloat(document.getElementById("flow").value);
  const V_input = parseFloat(document.getElementById("velocity").value);
  const geom = document.getElementById("geom").value;
  const scenKey = document.getElementById("scenario").value;
  const scen = scenarios[scenKey];

  const circOut = document.getElementById("circOut");
  const vEffTagEl = document.getElementById("vEffTag");
  const vRealTagEl = document.getElementById("vRealTag");

  circOut.style.display = "none";
  vEffTagEl.textContent = "n/d";
  vEffTagEl.className = "tag tag-na";
  vRealTagEl.textContent = "n/d";
  vRealTagEl.className = "tag tag-na";

  if (!Q || Q <= 0) {
    alert("Inserisci portata Q > 0");
    return;
  }

  let A = null;      // area m²
  let vEff = null;   // velocità effettiva
  const Q_m3s = Q / 3600;

  // Rettangolare
  if (geom === "rect") {
    let baseMm = parseFloat(document.getElementById("base").value);
    let heightMm = parseFloat(document.getElementById("height").value);
    let baseM = baseMm ? baseMm / 1000 : null;
    let heightM = heightMm ? heightMm / 1000 : null;

    if (V_input && V_input > 0) {
      // Dimensionamento: Q + V -> A
      A = Q_m3s / V_input;
      vEff = V_input;

      if (baseM && !heightM) {
        heightM = A / baseM;
        heightMm = heightM * 1000;
      } else if (!baseM && heightM) {
        baseM = A / heightM;
        baseMm = baseM * 1000;
      }

    } else {
      // Verifica: Q + sezione -> V
      if (!baseM || !heightM) {
        alert("Se la velocità non è nota, per sezione rettangolare devi inserire sia base che altezza.");
        return;
      }
      A = baseM * heightM;
      vEff = Q_m3s / A;
    }
  }

  // Circolare
  if (geom === "circ") {
    let dInputMm = parseFloat(document.getElementById("diam").value);
    let D_ins_m = dInputMm ? dInputMm / 1000 : null;

    if (V_input && V_input > 0) {
      // Dimensionamento: Q + V -> A
      A = Q_m3s / V_input;
      vEff = V_input;

      if (dInputMm && dInputMm > 0) {
        circOut.style.display = "";
        const A_ins = Math.PI * Math.pow(D_ins_m, 2) / 4;
        const V_real = Q_m3s / A_ins;
        document.getElementById("vRealOut").textContent =
          round(V_real, 2) + " m/s";

        const side_m = Math.sqrt(A_ins);
        const side_mm = side_m * 1000;
        document.getElementById("squareSideOut").textContent =
          round(side_mm, 1) + " mm";

        const vRealTag = getVelocityTag(V_real, scen.vMin, scen.vMax);
        vRealTagEl.textContent = vRealTag.text;
        vRealTagEl.className = "tag " + vRealTag.cls;
      } else {
        circOut.style.display = "none";
      }

    } else {
      // Verifica: Q + D -> A, V
      if (!D_ins_m) {
        alert("Se la velocità non è nota, per sezione circolare devi inserire il diametro.");
        return;
      }
      circOut.style.display = "";
      const A_ins = Math.PI * Math.pow(D_ins_m, 2) / 4;
      A = A_ins;
      vEff = Q_m3s / A_ins;

      document.getElementById("vRealOut").textContent =
        round(vEff, 2) + " m/s";

      const side_m = Math.sqrt(A_ins);
      const side_mm = side_m * 1000;
      document.getElementById("squareSideOut").textContent =
        round(side_mm, 1) + " mm";

      const vRealTag = getVelocityTag(vEff, scen.vMin, scen.vMax);
      vRealTagEl.textContent = vRealTag.text;
      vRealTagEl.className = "tag " + vRealTag.cls;
    }
  }

  if (!A || !vEff || A <= 0 || vEff <= 0) {
    alert("Impossibile determinare correttamente area e velocità. Controlla i dati.");
    return;
  }

  // Area in m² e mm²
  const A_mm2 = A * 1_000_000;
  document.getElementById("areaOut").textContent =
    round(A, 4) + " m² (" + round(A_mm2, 0) + " mm²)";

  // Deq
  const Deq_m = Math.sqrt(4 * A / Math.PI);
  const Deq_mm = Deq_m * 1000;
  document.getElementById("deqOut").textContent = round(Deq_mm, 1) + " mm";

  // conversioni
  document.getElementById("qM3sOut").textContent = round(Q_m3s, 4);
  document.getElementById("areaCm2Out").textContent = round(A * 10000, 1);
  document.getElementById("vKmhOut").textContent = round(vEff * 3.6, 2) + " km/h";

  document.getElementById("vEffOut").textContent = round(vEff, 2) + " m/s";
  const vEffTag = getVelocityTag(vEff, scen.vMin, scen.vMax);
  vEffTagEl.textContent = vEffTag.text;
  vEffTagEl.className = "tag " + vEffTag.cls;

  // DN standard più vicino a Deq
  let chosenDN = null;
  let minDiff = Infinity;
  for (let i = 0; i < stdDiameters.length; i++) {
    const diff = Math.abs(stdDiameters[i] - Deq_mm);
    if (diff < minDiff) {
      minDiff = diff;
      chosenDN = stdDiameters[i];
    }
  }

  if (chosenDN) {
    const D_chosen_m = chosenDN / 1000;
    const A_chosen = Math.PI * Math.pow(D_chosen_m, 2) / 4;
    const V_chosen = Q_m3s / A_chosen;

    document.getElementById("stdDNOut").textContent =
      "DN " + chosenDN + " mm";
    document.getElementById("stdDNVOut").textContent =
      round(V_chosen, 2) + " m/s";
  } else {
    document.getElementById("stdDNOut").textContent = "—";
    document.getElementById("stdDNVOut").textContent = "—";
  }
}
</script>

</body>
</html>
